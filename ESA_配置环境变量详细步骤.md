# ESA 配置环境变量详细步骤

## 🔴 当前问题

前端显示"无法连接到服务器"，这是因为前端还在使用默认的后端地址 `http://localhost:8000`，而不是实际的函数计算地址。

## ✅ 解决步骤

### 步骤 1: 进入 ESA 控制台

1. **登录阿里云控制台**
   - 访问：https://esa.console.aliyun.com/
   - 或搜索"弹性应用服务 ESA"

2. **找到你的应用**
   - 在应用列表中，找到你的前端应用
   - 点击应用名称进入应用详情

### 步骤 2: 进入构建信息页面

1. **点击"构建信息"或"修改"按钮**
   - 通常在应用详情页的顶部或侧边栏
   - 如果看到"修改"按钮，点击它

2. **找到"环境变量"部分**
   - 在构建信息页面中，向下滚动
   - 找到"环境变量"或"Environment Variables"部分

### 步骤 3: 添加环境变量

1. **点击"添加"或"新增"按钮**
   - 在环境变量部分，点击"添加"按钮

2. **填写环境变量信息**
   - **变量名**：`VITE_API_BASE_URL`
     - 注意：必须完全一致，包括大小写
     - 必须以 `VITE_` 开头（Vite 构建工具要求）
   
   - **变量值**：`http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run`
     - 注意：不要加末尾的斜杠 `/`
     - 使用 `http://` 协议

3. **保存环境变量**
   - 点击"确定"或"保存"按钮
   - 确认环境变量已添加到列表中

### 步骤 4: 重新构建前端

**重要：环境变量修改后，必须重新构建前端！**

1. **触发构建**
   - 在构建信息页面，找到"构建"或"重新构建"按钮
   - 点击触发构建
   - 等待构建完成（可能需要几分钟）

2. **检查构建日志**
   - 查看构建日志，确认构建成功
   - 如果有错误，查看错误信息

### 步骤 5: 创建并部署新版本

1. **创建新版本**
   - 构建成功后，在版本管理页面
   - 点击"创建版本"或"发布版本"
   - 等待版本创建完成

2. **部署新版本**
   - 选择新创建的版本
   - 点击"部署"或"发布"按钮
   - 等待部署完成

### 步骤 6: 清除浏览器缓存并测试

1. **清除浏览器缓存**
   - 按 `Ctrl+Shift+R`（Windows）或 `Cmd+Shift+R`（Mac）强制刷新
   - 或清除浏览器缓存后重新访问

2. **测试连接**
   - 打开前端页面
   - 尝试上传图片
   - 查看是否还有"无法连接到服务器"的错误

## 🔍 验证配置

### 方法 1: 检查浏览器控制台

1. **打开浏览器开发者工具**
   - 按 F12 或右键 → 检查
   - 切换到"控制台"（Console）标签

2. **运行验证命令**
   ```javascript
   console.log('API Base URL:', import.meta.env.VITE_API_BASE_URL);
   ```

3. **查看结果**
   - **应该显示**：`API Base URL: http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run`
   - **如果显示 `undefined`**：环境变量未正确配置，需要重新构建
   - **如果显示 `http://localhost:8000`**：环境变量未生效，需要重新构建

### 方法 2: 检查网络请求

1. **打开浏览器开发者工具**
   - 按 F12
   - 切换到"网络"（Network）标签

2. **刷新页面并上传图片**
   - 刷新页面
   - 尝试上传图片

3. **查看网络请求**
   - 在 Network 标签中，查找 API 请求
   - 查看请求的 URL
   - **应该看到**：请求发送到 `http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run`
   - **如果看到**：请求发送到 `http://localhost:8000`，说明环境变量未生效

## ⚠️ 常见错误

### 错误 1: 环境变量名称错误

**错误示例**：
- `VITE_API_BASE_URL` ❌（大小写错误）
- `API_BASE_URL` ❌（缺少 VITE_ 前缀）
- `vite_api_base_url` ❌（大小写错误）

**正确写法**：
- `VITE_API_BASE_URL` ✅

### 错误 2: 环境变量值错误

**错误示例**：
- `http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run/` ❌（末尾有斜杠）
- `https://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run` ❌（使用了 https，但后端是 http）
- `drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run` ❌（缺少协议）

**正确写法**：
- `http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run` ✅

### 错误 3: 配置后未重新构建

**症状**：
- 环境变量已配置
- 但前端仍无法连接

**解决方法**：
- 必须重新构建前端
- 必须部署新版本
- 清除浏览器缓存

## 📋 完整配置清单

- [ ] 已进入 ESA 控制台
- [ ] 已找到应用并进入构建信息页面
- [ ] 已找到"环境变量"部分
- [ ] 已添加环境变量：
  - [ ] 变量名：`VITE_API_BASE_URL`
  - [ ] 变量值：`http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run`
- [ ] 已保存环境变量
- [ ] 已触发重新构建
- [ ] 构建已成功完成
- [ ] 已创建新版本
- [ ] 已部署新版本
- [ ] 已清除浏览器缓存
- [ ] 已测试连接（上传图片成功）

## 🎯 快速操作指南

```
1. ESA 控制台 → 应用详情 → 构建信息
   ↓
2. 找到"环境变量" → 点击"添加"
   ↓
3. 变量名：VITE_API_BASE_URL
   变量值：http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run
   ↓
4. 保存 → 重新构建 → 创建版本 → 部署
   ↓
5. 清除浏览器缓存 → 测试
```

## 💡 提示

- **环境变量修改后必须重新构建**，否则不会生效
- **构建后必须部署新版本**，否则用户看不到更新
- **清除浏览器缓存**，确保加载最新版本
- **使用浏览器开发者工具**验证配置是否正确

---

**按照以上步骤操作，前端就能正常连接到后端了！** 🚀

