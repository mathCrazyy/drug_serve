# 为什么需要部署后端？后端如何部署？

## 🤔 为什么需要部署后端？

### 项目架构说明

这个项目采用**前后端分离架构**：

```
┌─────────────┐
│   前端      │  ← ESA 部署（静态文件）
│  (React)    │     - 用户界面
│             │     - 图片上传
│             │     - 数据显示
└──────┬──────┘
       │ HTTP 请求
       ↓
┌─────────────┐
│   后端      │  ← 需要单独部署（API 服务）
│  (FastAPI)  │     - 处理图片上传
│             │     - 调用豆包 API
│             │     - 数据库操作
└──────┬──────┘
       │ API 调用
       ↓
┌─────────────┐
│  豆包 API   │  ← 第三方服务
│  (AI 服务)  │     - 图片识别
│             │     - 信息提取
└─────────────┘
```

### 为什么不能只部署前端？

1. **前端是静态文件**
   - ESA 部署的是 HTML、CSS、JavaScript 文件
   - 这些文件运行在用户的浏览器中
   - 无法直接调用豆包 API（需要 API Key，不能暴露在前端）

2. **后端的作用**
   - 处理业务逻辑（图片上传、AI 识别）
   - 保护敏感信息（API Key 不能暴露在前端）
   - 连接数据库（存储药品信息）
   - 提供 API 接口（前端通过 HTTP 请求调用）

3. **安全考虑**
   - API Key 等敏感信息只能在后端使用
   - 前端代码是公开的，不能包含敏感信息

## 📋 后端部署方案

有两种主要方案：

### 方案 1: 函数计算（FC）- 推荐

**优点**：
- ✅ 无需管理服务器
- ✅ 按需付费，成本低
- ✅ 自动扩缩容
- ✅ 适合中小型应用

**缺点**：
- ⚠️ 需要处理文件存储（使用 OSS）
- ⚠️ 需要处理数据库（使用 RDS 或表格存储）

### 方案 2: ECS 服务器

**优点**：
- ✅ 完全控制
- ✅ 可以使用 SQLite（简单）
- ✅ 文件存储方便

**缺点**：
- ⚠️ 需要管理服务器
- ⚠️ 需要配置和维护
- ⚠️ 成本相对较高

## 🚀 后端部署详细步骤

### 方案 A: 函数计算（FC）部署

#### 第一步：创建函数计算服务

1. **登录函数计算控制台**
   - 访问：https://fcnext.console.aliyun.com/
   - 点击"创建服务"
   - 服务名称：`drug-serve-backend`
   - 点击"确定"

#### 第二步：创建 Web 函数

1. **在服务中创建函数**
   - 进入服务，点击"创建函数"
   - 选择"Web 函数"

2. **基本配置**
   - 函数名称：`drug-api`
   - 运行环境：Python 3.9
   - 请求处理程序：`app.main.app`（FastAPI 应用对象）

3. **上传代码**
   - 选择"通过文件夹上传"或"通过 ZIP 包上传"
   - 上传整个 `backend/` 目录

4. **配置环境变量**
   ```
   API_BASE_URL=https://api.chatfire.site/v1/chat/completions
   API_KEY=sk-pzZXi9zXV9ERBJFrjAVV4WEMj6u7TcTLtoNUkRfefSrLxlid
   MODEL_ID=doubao-1.5-vision-pro-250328
   DATABASE_URL=sqlite:///./drugs.db
   UPLOAD_DIR=/tmp/uploads
   MAX_FILE_SIZE=10485760
   ```

5. **高级配置**
   - 超时时间：60 秒
   - 内存规格：512 MB 或 1024 MB

#### 第三步：创建 HTTP 触发器

1. **创建触发器**
   - 在函数详情页，点击"触发器"
   - 点击"创建触发器"
   - 触发器类型：HTTP 触发器
   - 请求方法：GET, POST, PUT, DELETE（全选）
   - 认证方式：匿名访问

2. **获取访问地址**
   - 创建后会生成 HTTP 访问地址
   - 格式：`https://xxx.cn-hangzhou.fcapp.run`
   - **复制这个地址**，后续在 ESA 配置中使用

#### 第四步：配置文件存储（重要）

函数计算是临时环境，需要使用 OSS 存储文件：

1. **创建 OSS Bucket**
   - 在阿里云 OSS 控制台创建存储桶
   - 记录 Bucket 名称和访问域名

2. **修改代码使用 OSS**（需要修改代码）
   - 安装 OSS SDK：`pip install oss2`
   - 修改 `backend/app/routers/drugs.py`，使用 OSS 存储

3. **添加 OSS 环境变量**
   ```
   OSS_ACCESS_KEY_ID=your-key-id
   OSS_ACCESS_KEY_SECRET=your-key-secret
   OSS_ENDPOINT=oss-cn-hangzhou.aliyuncs.com
   OSS_BUCKET_NAME=your-bucket-name
   ```

**详细步骤请参考：`FC_函数计算部署指南.md`**

### 方案 B: ECS 服务器部署

#### 第一步：购买 ECS 服务器

1. **购买服务器**
   - 登录阿里云控制台
   - 购买 ECS 实例（建议 2核4G）
   - 选择操作系统（Ubuntu 20.04 或 CentOS 7）

#### 第二步：SSH 连接服务器

```bash
ssh root@your-ecs-ip
```

#### 第三步：安装依赖

```bash
# Ubuntu
sudo apt update
sudo apt install python3.9 python3.9-venv git nginx -y

# CentOS
sudo yum install python39 python39-pip git nginx -y
```

#### 第四步：部署代码

```bash
# 克隆代码
cd /opt
git clone https://github.com/mathCrazyy/drug_serve.git
cd drug_serve/backend

# 创建虚拟环境
python3.9 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 配置环境变量
cp .env.example .env
nano .env  # 编辑，填入豆包 API 配置
```

#### 第五步：配置环境变量（.env）

```env
API_BASE_URL=https://api.chatfire.site/v1/chat/completions
API_KEY=sk-pzZXi9zXV9ERBJFrjAVV4WEMj6u7TcTLtoNUkRfefSrLxlid
MODEL_ID=doubao-1.5-vision-pro-250328
DATABASE_URL=sqlite:///./drugs.db
UPLOAD_DIR=uploads
MAX_FILE_SIZE=10485760
```

#### 第六步：启动服务

```bash
# 使用 systemd 管理服务
sudo nano /etc/systemd/system/drug-serve.service
```

内容：
```ini
[Unit]
Description=Drug Serve Backend
After=network.target

[Service]
User=root
WorkingDirectory=/opt/drug_serve/backend
Environment="PATH=/opt/drug_serve/backend/venv/bin"
ExecStart=/opt/drug_serve/backend/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always

[Install]
WantedBy=multi-user.target
```

```bash
# 启动服务
sudo systemctl daemon-reload
sudo systemctl enable drug-serve
sudo systemctl start drug-serve
sudo systemctl status drug-serve
```

#### 第七步：配置防火墙

```bash
# 开放 8000 端口
sudo ufw allow 8000
sudo ufw enable
```

#### 第八步：测试

```bash
# 测试后端
curl http://your-ecs-ip:8000/
curl http://your-ecs-ip:8000/api/drugs
```

**详细步骤请参考：`ESA_完整部署流程.md`**

## 📊 两种方案对比

| 特性 | 函数计算（FC） | ECS 服务器 |
|------|--------------|-----------|
| 管理难度 | ⭐ 简单 | ⭐⭐⭐ 复杂 |
| 成本 | ⭐⭐ 按需付费 | ⭐⭐⭐ 固定成本 |
| 扩展性 | ⭐⭐⭐ 自动扩展 | ⭐⭐ 手动扩展 |
| 文件存储 | ⚠️ 需要 OSS | ✅ 本地存储 |
| 数据库 | ⚠️ 需要 RDS | ✅ SQLite 即可 |
| 适合场景 | 中小型应用 | 大型应用 |

## 🎯 推荐方案

**对于这个项目，推荐使用函数计算（FC）**：
- 项目规模适中
- 成本更低
- 无需管理服务器
- 自动扩缩容

## 📝 部署后需要做什么？

1. **获取后端地址**
   - 函数计算：HTTP 触发器地址
   - ECS：公网 IP 或域名

2. **在 ESA 配置前端环境变量**
   - 变量名：`VITE_API_BASE_URL`
   - 变量值：后端地址

3. **重新构建前端**
   - 在 ESA 控制台触发新的构建

4. **验证**
   - 打开前端应用
   - 测试上传图片功能

## 📚 相关文档

- `FC_函数计算部署指南.md` - 函数计算详细部署步骤
- `ESA_完整部署流程.md` - ECS 部署详细步骤
- `ESA_环境变量配置步骤.md` - 前端环境变量配置

---

**总结：后端必须部署，因为前端只是静态文件，需要后端提供 API 服务。推荐使用函数计算（FC）部署，更简单、成本更低。** 🚀

