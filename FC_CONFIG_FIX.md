# 函数计算配置修复指南

## 发现的问题

从你的配置截图看到：

### ❌ 问题 1：启动命令错误

**当前配置**：`./start.sh`  
**应该改为**：`./bootstrap`

**原因**：
- `start.sh` 是用于**本地开发**的脚本，会：
  - 创建虚拟环境（函数计算不需要）
  - 使用端口 8000（函数计算应该用 9000）
  - 使用 `--reload` 模式（生产环境不需要）
  
- `bootstrap` 是专门为**函数计算**设计的脚本，会：
  - 检查并安装依赖
  - 使用端口 9000（函数计算标准端口）
  - 适配函数计算环境

### ✅ 正确的配置

在函数计算控制台的"配置"页面，点击"编辑"：

1. **启动命令**：改为 `./bootstrap`（不是 `./start.sh`）
2. **监听端口**：`9000`（已正确）
3. **执行超时时间**：`1000 秒`（已正确，很好！）

### ⚠️ 问题 2：健康检查超时

虽然执行超时设置为 1000 秒，但**健康检查超时**可能仍然是 120 秒。

**健康检查超时**是函数计算检查端口 9000 是否可用的时间，如果 120 秒内应用没有启动，就会失败。

**解决方案**：
1. **使用 Dockerfile 构建镜像**（推荐）- 依赖在构建时安装，启动快
2. **或者**：首次启动时等待依赖安装完成（可能需要 3-5 分钟）

## 修复步骤

### 步骤 1：修改启动命令

1. 在函数计算控制台，进入函数配置
2. 点击"基础配置"右侧的"编辑"按钮
3. 将**启动命令**从 `./start.sh` 改为 `./bootstrap`
4. 保存配置

### 步骤 2：重新部署代码

确保代码包中包含 `bootstrap` 文件：

```bash
cd backend
chmod +x bootstrap
zip -r function.zip . \
    -x "venv/*" \
    -x "__pycache__/*" \
    -x "*.pyc" \
    -x ".git/*" \
    -x "*.db"
```

然后在函数计算控制台上传新的 `function.zip`。

### 步骤 3：验证

1. 查看日志，应该看到：
   ```
   === 检查依赖 ===
   ✓ 依赖已安装
   或
   依赖未安装，开始安装...
   ...
   ✓ 依赖安装完成，启动应用
   INFO:     Uvicorn running on http://0.0.0.0:9000
   ```

2. 测试函数，应该返回成功响应

## 获取 API 地址

修复配置后，获取 API 地址：

1. 在函数计算控制台，进入函数详情
2. 点击 **"触发器"** 标签
3. 找到 HTTP 触发器，查看 **"公网访问地址"**
4. 地址格式类似：
   ```
   https://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run
   ```
   或
   ```
   https://1234567890.cn-hangzhou.fc.aliyuncs.com/2016-08-15/proxy/drug-serve/api
   ```

5. **复制这个地址**，配置到 ESA 的 `VITE_API_BASE_URL` 环境变量

## 配置对比

| 配置项 | 当前（错误） | 应该改为 |
|--------|------------|---------|
| 启动命令 | `./start.sh` | `./bootstrap` |
| 监听端口 | 9000 | 9000 ✅ |
| 执行超时 | 1000秒 | 1000秒 ✅ |
| 运行环境 | 自定义运行时 Python 3.10 | ✅ 正确 |

## 如果仍然超时

如果修改后仍然出现健康检查超时：

1. **使用 Dockerfile 构建镜像**（最可靠）：
   ```bash
   cd backend
   docker build -t drug-serve-fc:latest -f Dockerfile .
   docker save drug-serve-fc:latest -o drug-serve-fc.tar
   ```
   然后上传 `drug-serve-fc.tar` 镜像文件

2. **或者等待首次启动完成**：
   - 首次启动需要安装依赖（3-5分钟）
   - 安装完成后，依赖会被缓存
   - 后续启动会很快（几秒钟）

## 总结

**立即操作**：
1. ✅ 将启动命令改为 `./bootstrap`
2. ✅ 重新上传代码包
3. ✅ 等待首次启动完成（依赖安装）
4. ✅ 获取 API 地址并配置到 ESA

**长期方案**：
- 使用 Dockerfile 构建镜像，避免运行时安装依赖

