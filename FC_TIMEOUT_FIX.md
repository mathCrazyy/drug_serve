# 函数计算超时问题解决方案

## 问题描述

```
Code: FunctionNotStarted
Message: Function instance health check failed on port 9000 in 120 seconds.
```

**原因**：
- 依赖安装太慢（14.9 kB/s，需要 2分48秒）
- 函数计算健康检查超时时间：120 秒（2分钟）
- 依赖还没安装完，应用还没启动，健康检查就超时了

## 解决方案

### 方案一：使用 Dockerfile 构建镜像（强烈推荐）⭐

**这是最佳方案**，依赖在构建时安装，运行时直接启动，无需等待。

#### 步骤：

1. **构建 Docker 镜像**：
```bash
cd backend
docker build -t drug-serve-fc:latest -f Dockerfile .
```

2. **导出镜像**：
```bash
docker save drug-serve-fc:latest -o drug-serve-fc.tar
```

3. **在函数计算控制台**：
   - 选择"自定义运行时"
   - 上传 `drug-serve-fc.tar` 镜像文件
   - 启动命令：`./bootstrap`
   - **超时时间**：设置为 300 秒（5分钟）或更长

#### 优势：
- ✅ 依赖已在镜像中，启动速度快
- ✅ 不占用运行时时间
- ✅ 更可靠，不受网络影响

### 方案二：优化 bootstrap 脚本（已实现）

已优化 `bootstrap` 脚本：
- ✅ **智能检测**：如果依赖已安装，跳过安装步骤
- ✅ **快速启动**：只在首次启动时安装依赖
- ✅ **超时设置**：pip 安装超时设置为 300 秒

#### 使用步骤：

1. **首次部署**（需要安装依赖）：
   - 在函数计算控制台设置**超时时间**为 **300 秒**（5分钟）
   - 上传代码包
   - 等待首次启动完成（依赖安装）

2. **后续启动**：
   - 依赖已安装，启动速度快
   - 可以降低超时时间到 60 秒

### 方案三：增加函数计算超时时间

在函数计算控制台：
1. 进入函数配置
2. 找到"超时时间"设置
3. 设置为 **300 秒**（5分钟）或更长
4. 保存配置

### 方案四：使用更快的镜像源

已使用清华镜像源，如果仍然慢，可以尝试：

```bash
# 阿里云镜像（如果在阿里云环境）
-i https://mirrors.aliyun.com/pypi/simple/

# 或者豆瓣镜像
-i https://pypi.douban.com/simple/
```

## 推荐配置

### 使用 Dockerfile（推荐）

1. **构建镜像**（本地或 CI/CD）：
```bash
cd backend
docker build -t drug-serve-fc:latest -f Dockerfile .
docker save drug-serve-fc:latest -o drug-serve-fc.tar
```

2. **函数计算配置**：
   - 运行环境：自定义运行时
   - 代码包：上传 `drug-serve-fc.tar`
   - 启动命令：`./bootstrap`
   - 超时时间：**60 秒**（足够，因为依赖已安装）

### 使用代码包（备选）

1. **函数计算配置**：
   - 运行环境：自定义运行时 (Debian10) Python 3.10
   - 代码包：上传 `function.zip`
   - 启动命令：`./bootstrap`
   - 超时时间：**300 秒**（首次启动需要安装依赖）

2. **首次启动后**：
   - 依赖已安装，可以降低超时时间到 60 秒

## 验证

部署后，查看函数计算日志，应该看到：

**使用 Dockerfile**：
```
=== 环境信息 ===
=== 检查依赖 ===
✓ 依赖已安装，跳过安装步骤
=== 启动 FastAPI 应用 ===
INFO:     Started server process
```

**使用代码包（首次）**：
```
=== 环境信息 ===
=== 检查依赖 ===
uvicorn 未安装
=== 安装 Python 依赖（首次启动）===
[安装过程...]
✓ 依赖安装完成
=== 启动 FastAPI 应用 ===
```

## 注意事项

1. **首次启动**：如果使用代码包，首次启动需要安装依赖，会较慢
2. **超时时间**：确保超时时间足够长（至少 300 秒用于首次启动）
3. **网络问题**：如果网络慢，考虑使用 Dockerfile 方案
4. **依赖大小**：Pillow 等包较大，建议使用 Dockerfile 预安装

## 总结

**最佳实践**：使用 Dockerfile 构建镜像，依赖在构建时安装，运行时直接启动。

这样可以：
- ✅ 避免运行时安装依赖的延迟
- ✅ 避免健康检查超时
- ✅ 提高启动速度
- ✅ 更可靠的部署

