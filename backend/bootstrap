#!/bin/bash
# 阿里云函数计算启动脚本（自定义运行时）

set -e  # 遇到错误立即退出

# 进入代码目录
cd /code

# 检测 Python 解释器路径
if [ -f "/var/fc/lang/python3.10/bin/python3" ]; then
    PYTHON="/var/fc/lang/python3.10/bin/python3"
    PIP="/var/fc/lang/python3.10/bin/pip3"
elif [ -f "/usr/bin/python3" ]; then
    PYTHON="/usr/bin/python3"
    PIP="/usr/bin/pip3"
else
    PYTHON="python3"
    PIP="pip3"
fi

# 显示环境信息
echo "=== 环境信息 ==="
echo "使用 Python: $PYTHON"
echo "Python 版本: $($PYTHON --version 2>&1)"
echo "使用 Pip: $PIP"
echo "当前目录: $(pwd)"

# 快速检查关键依赖是否已安装
echo "=== 检查依赖 ==="
DEPENDENCIES_INSTALLED=true
if ! $PYTHON -c "import uvicorn" 2>/dev/null; then
    echo "uvicorn 未安装"
    DEPENDENCIES_INSTALLED=false
fi
if ! $PYTHON -c "import fastapi" 2>/dev/null; then
    echo "fastapi 未安装"
    DEPENDENCIES_INSTALLED=false
fi

# 只有在依赖未安装时才安装（避免每次启动都安装）
if [ "$DEPENDENCIES_INSTALLED" = false ]; then
    echo "=== 安装 Python 依赖（首次启动）==="
    
    # 检查 requirements.txt 是否存在
    if [ ! -f "requirements.txt" ]; then
        echo "错误: requirements.txt 文件不存在！"
        exit 1
    fi
    
    # 使用最快的镜像源和并行安装
    if [ -f "/var/fc/lang/python3.10/bin/pip3" ]; then
        /var/fc/lang/python3.10/bin/pip3 install --no-cache-dir -r requirements.txt \
            -i https://pypi.tuna.tsinghua.edu.cn/simple \
            --default-timeout=300 2>&1 | grep -v "^$" | tail -20
    else
        $PIP install --no-cache-dir -r requirements.txt \
            -i https://pypi.tuna.tsinghua.edu.cn/simple \
            --default-timeout=300 2>&1 | grep -v "^$" | tail -20
    fi
    
    # 快速验证
    if ! $PYTHON -c "import uvicorn" 2>/dev/null; then
        echo "错误: uvicorn 安装失败"
        exit 1
    fi
    echo "✓ 依赖安装完成"
else
    echo "✓ 依赖已安装，跳过安装步骤"
fi

# 设置 Python 路径
export PYTHONPATH=/code:$PYTHONPATH

# 创建必要的目录
mkdir -p /tmp/uploads 2>/dev/null || true

# 启动应用（立即启动，不等待）
echo "=== 启动 FastAPI 应用 ==="
echo "监听地址: 0.0.0.0:9000"
exec $PYTHON -m uvicorn app.main:app --host 0.0.0.0 --port 9000
