#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
阿里云函数计算启动脚本
"""

import sys
import os

# 添加当前目录到 Python 路径
current_dir = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, current_dir)

# 确保依赖已安装（函数计算会自动安装 requirements.txt 中的依赖）
# 这里直接导入应用
from app.main import app

# 对于函数计算，需要使用 ASGI 适配器
try:
    from mangum import Mangum
    handler = Mangum(app, lifespan="off")
    
    # 函数计算的入口函数
    def handler_wrapper(environ, start_response):
        """WSGI 兼容的入口函数"""
        return handler(environ, start_response)
    
    # 如果直接运行，使用 uvicorn
    if __name__ == "__main__":
        import uvicorn
        port = int(os.environ.get("PORT", 9000))
        uvicorn.run(app, host="0.0.0.0", port=port)
        
except ImportError:
    # 如果没有 mangum，直接使用 uvicorn
    import uvicorn
    port = int(os.environ.get("PORT", 9000))
    uvicorn.run(app, host="0.0.0.0", port=port)
