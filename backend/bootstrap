#!/bin/bash
# 阿里云函数计算启动脚本（自定义运行时）
# 注意：依赖已在 Docker 镜像构建时安装，这里只需要启动应用

set -e

# 进入代码目录
cd /code

# 显示环境信息
echo "=== 环境信息 ==="
echo "Python 版本: $(python3 --version)"
echo "当前目录: $(pwd)"

# 验证关键依赖（依赖应该在镜像中已安装）
echo "=== 验证依赖 ==="
python3 -c "import uvicorn; print('✓ uvicorn:', uvicorn.__version__)" || {
    echo "✗ 错误: uvicorn 未找到，请检查镜像构建过程"
    exit 1
}

python3 -c "import fastapi; print('✓ fastapi:', fastapi.__version__)" || {
    echo "✗ 错误: fastapi 未找到，请检查镜像构建过程"
    exit 1
}

# 设置 Python 路径
export PYTHONPATH=/code:$PYTHONPATH

# 创建必要的目录
mkdir -p /tmp/uploads

# 启动应用
echo "=== 启动 FastAPI 应用 ==="
echo "监听地址: 0.0.0.0:9000"
exec python3 -m uvicorn app.main:app --host 0.0.0.0 --port 9000
