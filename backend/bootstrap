#!/bin/bash
# 阿里云函数计算启动脚本（自定义运行时）

set -e

cd /code

# 检测 Python 解释器
if [ -f "/var/fc/lang/python3.10/bin/python3" ]; then
    PYTHON="/var/fc/lang/python3.10/bin/python3"
    PIP="/var/fc/lang/python3.10/bin/pip3"
else
    PYTHON="python3"
    PIP="pip3"
fi

echo "=== 检查依赖 ==="
if $PYTHON -c "import uvicorn, fastapi" 2>/dev/null; then
    echo "✓ 依赖已安装"
    export PYTHONPATH=/code:$PYTHONPATH
    mkdir -p /tmp/uploads 2>/dev/null || true
    exec $PYTHON -m uvicorn app.main:app --host 0.0.0.0 --port 9000
fi

echo "依赖未安装，开始安装..."
echo "注意：首次启动需要安装依赖，可能需要 3-5 分钟"
echo "请在函数计算控制台将超时时间设置为 300 秒（5分钟）"

# 安装依赖
if [ -f "/var/fc/lang/python3.10/bin/pip3" ]; then
    /var/fc/lang/python3.10/bin/pip3 install --no-cache-dir -r requirements.txt \
        -i https://pypi.tuna.tsinghua.edu.cn/simple 2>&1
else
    $PIP install --no-cache-dir -r requirements.txt \
        -i https://pypi.tuna.tsinghua.edu.cn/simple 2>&1
fi

# 验证
if ! $PYTHON -c "import uvicorn, fastapi" 2>/dev/null; then
    echo "错误: 依赖安装失败"
    exit 1
fi

echo "✓ 依赖安装完成，启动应用"
export PYTHONPATH=/code:$PYTHONPATH
mkdir -p /tmp/uploads 2>/dev/null || true
exec $PYTHON -m uvicorn app.main:app --host 0.0.0.0 --port 9000
