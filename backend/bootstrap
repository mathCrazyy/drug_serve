#!/bin/bash
# 阿里云函数计算启动脚本（自定义运行时）

set -e  # 遇到错误立即退出

# 进入代码目录
cd /code

# 检测 Python 解释器路径
if [ -f "/var/fc/lang/python3.10/bin/python3" ]; then
    PYTHON="/var/fc/lang/python3.10/bin/python3"
    PIP="/var/fc/lang/python3.10/bin/pip3"
elif [ -f "/usr/bin/python3" ]; then
    PYTHON="/usr/bin/python3"
    PIP="/usr/bin/pip3"
else
    PYTHON="python3"
    PIP="pip3"
fi

# 显示环境信息
echo "=== 环境信息 ==="
echo "使用 Python: $PYTHON"
echo "Python 版本: $($PYTHON --version 2>&1)"
echo "使用 Pip: $PIP"
echo "Pip 版本: $($PIP --version 2>&1)"
echo "当前目录: $(pwd)"
echo "工作目录内容:"
ls -la /code | head -10

# 检查 requirements.txt 是否存在
if [ ! -f "requirements.txt" ]; then
    echo "错误: requirements.txt 文件不存在！"
    exit 1
fi

echo "=== 检查 requirements.txt ==="
cat requirements.txt

# 安装依赖（尝试多种方式）
echo "=== 安装 Python 依赖 ==="

# 方法1: 使用函数计算的 pip（如果存在）
if [ -f "/var/fc/lang/python3.10/bin/pip3" ]; then
    echo "方法1: 使用函数计算的 pip 安装..."
    /var/fc/lang/python3.10/bin/pip3 install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple 2>&1 || {
        echo "方法1 失败，尝试方法2..."
        # 方法2: 使用 --user 安装到用户目录
        /var/fc/lang/python3.10/bin/pip3 install --user --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple 2>&1 || {
            echo "方法2 失败，尝试方法3..."
            # 方法3: 使用系统 pip
            pip3 install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple 2>&1
        }
    }
else
    # 如果没有函数计算的 pip，使用系统 pip
    echo "使用系统 pip 安装..."
    $PIP install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple 2>&1 || {
        echo "尝试使用 --user 安装..."
        $PIP install --user --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple 2>&1
    }
fi

# 显示安装的包
echo "=== 已安装的包 ==="
$PIP list 2>&1 | grep -E "(uvicorn|fastapi|sqlalchemy)" || echo "未找到关键包"

# 验证关键依赖
echo "=== 验证依赖安装 ==="

# 验证 uvicorn
$PYTHON -c "import uvicorn; print('✓ uvicorn:', uvicorn.__version__)" 2>&1
if [ $? -ne 0 ]; then
    echo "✗ 错误: uvicorn 未找到"
    echo "Python 搜索路径:"
    $PYTHON -c "import sys; print('\n'.join(sys.path))" 2>&1
    echo "尝试查找 uvicorn 安装位置:"
    $PIP show uvicorn 2>&1 || echo "pip show 失败"
    find /var/fc -name "uvicorn" -type f 2>/dev/null | head -5 || echo "未找到 uvicorn"
    exit 1
fi

# 验证 fastapi
$PYTHON -c "import fastapi; print('✓ fastapi:', fastapi.__version__)" 2>&1 || {
    echo "✗ 错误: fastapi 未找到"
    exit 1
}

# 验证其他关键依赖
echo "验证其他依赖..."
$PYTHON -c "import sqlalchemy; print('✓ sqlalchemy:', sqlalchemy.__version__)" 2>&1 || echo "警告: sqlalchemy 未找到"
$PYTHON -c "import aiofiles; print('✓ aiofiles 已安装')" 2>&1 || echo "警告: aiofiles 未找到"

# 设置 Python 路径
export PYTHONPATH=/code:$PYTHONPATH

# 显示最终配置
echo "=== 最终配置 ==="
echo "PYTHONPATH: $PYTHONPATH"
echo "工作目录: $(pwd)"
echo "使用 Python: $PYTHON"
echo "Python 可执行文件: $(which python3 2>/dev/null || echo '未找到')"

# 创建必要的目录
mkdir -p /tmp/uploads 2>/dev/null || true

# 启动应用
echo "=== 启动 FastAPI 应用 ==="
echo "监听地址: 0.0.0.0:9000"
exec $PYTHON -m uvicorn app.main:app --host 0.0.0.0 --port 9000
