#!/bin/bash
# 阿里云函数计算启动脚本（自定义运行时）

# 不立即退出，以便查看错误信息
set +e

# 进入代码目录
cd /code

# 检测 Python 解释器路径
if [ -f "/var/fc/lang/python3.10/bin/python3" ]; then
    PYTHON="/var/fc/lang/python3.10/bin/python3"
    PIP="/var/fc/lang/python3.10/bin/pip3"
elif [ -f "/usr/bin/python3" ]; then
    PYTHON="/usr/bin/python3"
    PIP="/usr/bin/pip3"
else
    PYTHON="python3"
    PIP="pip3"
fi

# 显示环境信息
echo "=== 环境信息 ==="
echo "使用 Python: $PYTHON"
echo "Python 版本: $($PYTHON --version 2>&1)"
echo "使用 Pip: $PIP"
echo "Pip 版本: $($PIP --version 2>&1)"
echo "当前目录: $(pwd)"
echo "Python 路径: $PYTHONPATH"

# 显示 Python 可执行文件位置
echo "Python 路径: $(which python3 2>/dev/null || echo '未找到')"
echo "Pip 路径: $(which pip3 2>/dev/null || echo '未找到')"

# 强制安装依赖到函数计算的 Python 环境
echo "=== 安装 Python 依赖 ==="
$PIP install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple 2>&1

# 检查安装结果
INSTALL_RESULT=$?
if [ $INSTALL_RESULT -ne 0 ]; then
    echo "警告: 依赖安装可能有问题，退出码: $INSTALL_RESULT"
    echo "尝试使用系统 pip..."
    pip3 install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple 2>&1
fi

# 验证关键依赖
echo "=== 验证依赖安装 ==="
$PYTHON -c "import uvicorn; print('✓ uvicorn:', uvicorn.__version__)" 2>&1
if [ $? -ne 0 ]; then
    echo "✗ 错误: uvicorn 未找到"
    echo "尝试查找 uvicorn..."
    $PIP list 2>&1 | grep uvicorn || echo "uvicorn 未在已安装包列表中"
    $PYTHON -c "import sys; print('Python 路径:', sys.path)" 2>&1
    echo "尝试直接导入..."
    $PYTHON -c "import sys; sys.path.insert(0, '/code'); import uvicorn" 2>&1
    exit 1
fi

$PYTHON -c "import fastapi; print('✓ fastapi:', fastapi.__version__)" 2>&1 || {
    echo "警告: fastapi 可能未正确安装"
}

# 设置 Python 路径
export PYTHONPATH=/code:$PYTHONPATH

# 显示最终配置
echo "=== 最终配置 ==="
echo "PYTHONPATH: $PYTHONPATH"
echo "工作目录: $(pwd)"
echo "使用 Python: $PYTHON"

# 启动应用（使用检测到的 Python 解释器）
echo "=== 启动 FastAPI 应用 ==="
echo "监听地址: 0.0.0.0:9000"
exec $PYTHON -m uvicorn app.main:app --host 0.0.0.0 --port 9000
