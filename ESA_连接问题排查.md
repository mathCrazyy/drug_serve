# ESA 前端连接后端问题排查

## 🔴 当前问题

前端显示："无法连接到服务器,请检查网络连接或确认后端服务是否运行"

## 📋 问题原因

前端已部署到 ESA，但无法连接到后端服务。可能的原因：

1. **后端服务未部署**
2. **VITE_API_BASE_URL 环境变量未配置或配置错误**
3. **后端服务地址不正确**

## 🔍 排查步骤

### 步骤 1: 检查后端是否已部署

**如果使用函数计算（FC）**：
1. 登录函数计算控制台：https://fcnext.console.aliyun.com/
2. 检查函数是否已创建并部署
3. 检查 HTTP 触发器是否已创建
4. 获取 HTTP 触发器地址（类似：`https://xxx.cn-hangzhou.fcapp.run`）

**如果使用 ECS**：
1. 检查 ECS 服务器是否运行
2. 检查后端服务是否启动
3. 获取 ECS 公网 IP 或域名

### 步骤 2: 检查 ESA 环境变量配置

1. **登录 ESA 控制台**
   - 访问：https://esa.console.aliyun.com/
   - 找到应用：`drug_serve`

2. **检查环境变量**
   - 进入"构建信息" → "环境变量"
   - 检查是否有 `VITE_API_BASE_URL` 环境变量
   - 检查值是否正确指向后端地址

3. **如果环境变量未配置**
   - 点击"添加"
   - 变量名：`VITE_API_BASE_URL`
   - 变量值：后端服务地址
     - 函数计算：`https://xxx.cn-hangzhou.fcapp.run`
     - ECS：`http://your-ecs-ip:8000`

4. **重新构建**
   - 保存环境变量后
   - 重新触发构建和部署

### 步骤 3: 测试后端连接

在浏览器中测试后端是否可访问：

```bash
# 如果使用函数计算
curl https://your-fc-url.cn-hangzhou.fcapp.run/

# 如果使用 ECS
curl http://your-ecs-ip:8000/
```

应该返回 JSON 数据，而不是连接错误。

### 步骤 4: 检查浏览器控制台

1. 打开前端应用
2. 按 F12 打开开发者工具
3. 查看 Console 标签，检查错误信息
4. 查看 Network 标签，检查 API 请求：
   - 请求的 URL 是什么？
   - 请求是否成功？
   - 错误状态码是什么？

## 🔧 解决方案

### 方案 1: 后端未部署

**需要先部署后端**：

1. **使用函数计算（推荐）**
   - 参考：`FC_函数计算部署指南.md`
   - 部署后端到函数计算
   - 创建 HTTP 触发器
   - 获取触发器地址

2. **使用 ECS**
   - 参考：`ESA_完整部署流程.md`
   - 部署后端到 ECS
   - 获取 ECS 公网 IP

### 方案 2: 环境变量未配置

**在 ESA 配置环境变量**：

1. 进入 ESA 控制台 → 构建信息 → 环境变量
2. 添加：
   ```
   VITE_API_BASE_URL = https://your-backend-url
   ```
3. 保存并重新构建

### 方案 3: 环境变量配置错误

**检查并修正环境变量值**：

1. 确认后端服务地址是否正确
2. 确认地址格式：
   - 函数计算：`https://xxx.cn-hangzhou.fcapp.run`
   - ECS：`http://ip:8000` 或 `https://domain.com`
3. 确认没有多余的空格或字符

### 方案 4: CORS 问题

如果后端已部署但仍有连接问题，可能是 CORS 配置问题：

**检查后端 CORS 配置**：
- 确保后端允许前端域名访问
- 函数计算需要配置 CORS 响应头

## 📝 快速检查清单

- [ ] 后端服务已部署（函数计算或 ECS）
- [ ] 后端服务可以访问（测试 curl 命令）
- [ ] ESA 环境变量 `VITE_API_BASE_URL` 已配置
- [ ] 环境变量值正确指向后端地址
- [ ] 前端已重新构建（配置环境变量后）
- [ ] 浏览器控制台检查（F12）

## 🎯 推荐操作流程

1. **部署后端**（如果还没部署）
   - 使用函数计算或 ECS
   - 获取后端访问地址

2. **配置 ESA 环境变量**
   - 变量名：`VITE_API_BASE_URL`
   - 变量值：后端地址

3. **重新构建前端**
   - 在 ESA 控制台触发新的构建

4. **验证连接**
   - 打开前端应用
   - 检查是否还有连接错误
   - 查看浏览器控制台

## ⚠️ 重要提示

1. **环境变量必须在构建前配置**
   - `VITE_` 开头的环境变量在构建时会被替换
   - 构建后修改环境变量不会生效，需要重新构建

2. **后端必须先部署**
   - 前端需要知道后端地址才能连接
   - 如果后端还没部署，先部署后端

3. **检查地址格式**
   - 确保使用正确的协议（http 或 https）
   - 确保端口号正确（如果有）
   - 确保没有多余的空格

---

**按照以上步骤排查，应该能解决连接问题！** 🚀

