# 函数计算部署后问题排查

## 🔍 问题排查步骤

### 第一步：检查函数是否正常运行

1. **测试函数**
   - 在函数详情页，点击"测试"标签
   - 或点击右上角的"测试函数"按钮
   - 创建一个测试事件，测试函数是否能正常执行

2. **查看函数日志**
   - 点击"日志"标签
   - 查看是否有错误信息
   - 检查函数是否正常启动

### 第二步：检查 HTTP 触发器

1. **确认触发器已创建**
   - 点击"触发器"标签
   - 确认有 HTTP 触发器
   - 检查触发器状态是否正常

2. **获取触发器地址**
   - 在触发器列表中，找到 HTTP 触发器
   - 复制"公网访问地址"或"HTTP 触发器地址"
   - 地址格式：`https://xxx.cn-hangzhou.fcapp.run`

3. **测试触发器地址**
   ```bash
   # 在浏览器或终端中测试
   curl https://your-function-url.cn-hangzhou.fcapp.run/
   ```
   
   应该返回：
   ```json
   {"message":"药品识别与提醒系统 API","docs":"/docs"}
   ```

### 第三步：检查环境变量

1. **进入配置页面**
   - 点击"配置"标签
   - 找到"环境变量"部分

2. **确认环境变量已配置**
   检查以下环境变量是否存在：
   - `API_BASE_URL`
   - `API_KEY`
   - `MODEL_ID`
   - `DATABASE_URL`
   - `UPLOAD_DIR`
   - `MAX_FILE_SIZE`

3. **检查环境变量值**
   - 确认值是否正确
   - 特别是 `API_KEY` 和 `MODEL_ID`

### 第四步：检查代码配置

1. **检查请求处理程序**
   - 在"配置"页面，找到"请求处理程序"
   - 应该是：`app.main.app`
   - 如果不是，需要修改

2. **检查运行环境**
   - 确认运行环境是 Python 3.9 或 Python 3.10
   - 确认代码已正确上传

3. **检查代码结构**
   - 在"代码"标签，确认文件结构正确：
     ```
     app/
     ├── main.py
     ├── database.py
     ├── models.py
     ├── routers/
     └── services/
     requirements.txt
     ```

### 第五步：检查前端配置

1. **确认 ESA 环境变量已配置**
   - 登录 ESA 控制台
   - 进入"构建信息" → "环境变量"
   - 确认 `VITE_API_BASE_URL` 已配置
   - 值应该是函数计算的 HTTP 触发器地址

2. **确认前端已重新构建**
   - 配置环境变量后，必须重新构建
   - 在 ESA 控制台触发新的构建

### 第六步：常见问题

#### 问题 1: 函数测试失败

**可能原因**：
- 代码错误
- 环境变量未配置
- 依赖未安装

**解决方法**：
1. 查看函数日志，找到错误信息
2. 检查 `requirements.txt` 是否包含所有依赖
3. 检查环境变量是否正确配置

#### 问题 2: HTTP 触发器无法访问

**可能原因**：
- 触发器未创建
- 触发器地址错误
- 认证方式配置错误

**解决方法**：
1. 确认 HTTP 触发器已创建
2. 检查触发器认证方式（应该是"匿名访问"）
3. 测试触发器地址是否可访问

#### 问题 3: 前端无法连接后端

**可能原因**：
- `VITE_API_BASE_URL` 未配置或配置错误
- 前端未重新构建
- CORS 配置问题

**解决方法**：
1. 确认 ESA 环境变量 `VITE_API_BASE_URL` 已配置
2. 确认值是正确的函数计算地址
3. 重新构建前端
4. 检查后端 CORS 配置

#### 问题 4: 函数超时

**可能原因**：
- AI 识别需要较长时间
- 超时时间设置太短

**解决方法**：
1. 在"配置"页面，增加超时时间到 120 秒
2. 保存并重新部署

## 🧪 快速测试步骤

### 1. 测试函数健康检查

在浏览器中访问：
```
https://your-function-url.cn-hangzhou.fcapp.run/
```

应该返回：
```json
{"message":"药品识别与提醒系统 API","docs":"/docs"}
```

### 2. 测试 API 接口

```bash
curl https://your-function-url.cn-hangzhou.fcapp.run/api/drugs
```

应该返回 JSON 数组（可能是空的 `[]`）。

### 3. 测试前端连接

1. 打开前端应用
2. 按 F12 打开开发者工具
3. 查看 Network 标签
4. 检查 API 请求的 URL 是否正确
5. 检查请求是否成功

## 📋 检查清单

- [ ] 函数已创建并部署
- [ ] HTTP 触发器已创建
- [ ] 触发器地址已获取
- [ ] 环境变量已配置（6 个）
- [ ] 函数测试通过
- [ ] 触发器地址可以访问（curl 测试）
- [ ] ESA 环境变量 `VITE_API_BASE_URL` 已配置
- [ ] 前端已重新构建
- [ ] 浏览器控制台检查（F12）

## 🎯 需要的信息

请告诉我：

1. **函数测试结果**
   - 在函数计算控制台测试函数，结果如何？
   - 是否有错误信息？

2. **HTTP 触发器地址**
   - 触发器地址是什么？
   - 能否在浏览器中访问？

3. **前端错误信息**
   - 前端显示什么错误？
   - 浏览器控制台（F12）有什么错误？

4. **环境变量配置**
   - 函数计算的环境变量是否都已配置？
   - ESA 的 `VITE_API_BASE_URL` 是否已配置？

---

**请提供以上信息，我可以帮你进一步排查问题！** 🔍

