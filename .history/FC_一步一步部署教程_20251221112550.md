# 函数计算（FC）部署后端 - 一步一步教程

## 📋 准备工作

### 需要的信息

从 `test.py` 文件中，我们已经知道：
- API_BASE_URL: `https://api.chatfire.site/v1/chat/completions`
- API_KEY: `sk-pzZXi9zXV9ERBJFrjAVV4WEMj6u7TcTLtoNUkRfefSrLxlid`
- MODEL_ID: `doubao-1.5-vision-pro-250328`

## 🚀 第一步：登录函数计算控制台

1. **打开浏览器**
   - 访问：https://fcnext.console.aliyun.com/
   - 或搜索"函数计算 FC"

2. **登录阿里云账号**
   - 使用你的阿里云账号登录
   - 如果没有账号，需要先注册

3. **进入函数计算控制台**
   - 登录后会自动进入函数计算控制台
   - 如果提示开通服务，点击"立即开通"

## 📦 第二步：创建服务

1. **点击"创建服务"按钮**
   - 在函数计算控制台首页
   - 找到"服务及函数" → "服务"
   - 点击右上角的"创建服务"按钮

2. **填写服务信息**
   - **服务名称**：`drug-serve-backend`
   - **描述**：`药品识别系统后端服务`（可选）
   - 其他选项保持默认

3. **点击"确定"**
   - 等待服务创建完成
   - 创建成功后会自动进入服务详情页

## 🔧 第三步：创建函数

### 3.1 进入创建函数页面

1. **在服务详情页**
   - 你会看到"函数"标签页
   - 点击"创建函数"按钮

2. **选择创建方式**
   - 选择"**Web 函数**"（推荐）
   - 这是专门用于 HTTP 服务的函数类型

### 3.2 基本配置

1. **函数名称**
   - 输入：`drug-api`
   - 这是函数的标识名称

2. **运行环境**
   - 选择：`Python 3.9`
   - 或 `Python 3.10`（如果有）

3. **请求处理程序类型**
   - 选择：`处理 HTTP 请求`

4. **请求处理程序**
   - 输入：`app.main.app`
   - 这是 FastAPI 应用对象的路径

### 3.3 代码配置

1. **代码上传方式**
   - 选择"**通过文件夹上传**"或"**通过 ZIP 包上传**"
   
2. **准备代码包**
   
   **方法 A：直接上传文件夹**
   - 在本地，进入 `backend/` 目录
   - 确保包含所有文件：
     ```
     backend/
     ├── app/
     │   ├── main.py
     │   ├── database.py
     │   ├── models.py
     │   ├── routers/
     │   └── services/
     ├── requirements.txt
     └── .env.example
     ```
   
   **方法 B：打包为 ZIP**
   ```bash
   cd /Users/chunshengwu/code/drug_serve/backend
   zip -r function.zip . -x "*.pyc" "__pycache__/*" "*.git*" "venv/*" "*.db"
   ```
   
3. **上传代码**
   - 点击"上传"按钮
   - 选择 `backend/` 文件夹或 `function.zip` 文件
   - 等待上传完成

### 3.4 环境变量配置

1. **找到环境变量部分**
   - 在函数配置页面，向下滚动
   - 找到"环境变量"部分

2. **添加环境变量**
   
   点击"添加"按钮，逐个添加以下环境变量：
   
   **第一个环境变量：**
   - 变量名：`API_BASE_URL`
   - 变量值：`https://api.chatfire.site/v1/chat/completions`
   - 点击"确定"
   
   **第二个环境变量：**
   - 变量名：`API_KEY`
   - 变量值：`sk-pzZXi9zXV9ERBJFrjAVV4WEMj6u7TcTLtoNUkRfefSrLxlid`
   - 点击"确定"
   
   **第三个环境变量：**
   - 变量名：`MODEL_ID`
   - 变量值：`doubao-1.5-vision-pro-250328`
   - 点击"确定"
   
   **第四个环境变量：**
   - 变量名：`DATABASE_URL`
   - 变量值：`sqlite:///./drugs.db`
   - 点击"确定"
   
   **第五个环境变量：**
   - 变量名：`UPLOAD_DIR`
   - 变量值：`/tmp/uploads`
   - 点击"确定"
   
   **第六个环境变量：**
   - 变量名：`MAX_FILE_SIZE`
   - 变量值：`10485760`
   - 点击"确定"

3. **确认环境变量**
   - 检查所有环境变量都已添加
   - 确认变量名和值都正确

### 3.5 高级配置

1. **超时时间**
   - 找到"超时时间"设置
   - 设置为：`60` 秒
   - AI 识别可能需要较长时间

2. **内存规格**
   - 找到"内存规格"设置
   - 选择：`512 MB` 或 `1024 MB`
   - 建议选择 `1024 MB`（处理图片需要更多内存）

3. **实例并发**
   - 保持默认：`1`
   - 或根据需要调整

### 3.6 创建函数

1. **检查配置**
   - 确认所有配置都正确
   - 特别是环境变量和代码上传

2. **点击"创建"按钮**
   - 等待函数创建完成
   - 创建成功后会自动进入函数详情页

## 🌐 第四步：创建 HTTP 触发器

### 4.1 进入触发器页面

1. **在函数详情页**
   - 找到"触发器"标签页
   - 点击进入

2. **点击"创建触发器"按钮**
   - 在触发器列表页面
   - 点击右上角的"创建触发器"

### 4.2 配置触发器

1. **触发器类型**
   - 选择：`HTTP 触发器`

2. **触发器名称**
   - 输入：`http-trigger`
   - 或保持默认

3. **请求方法**
   - 勾选：`GET`、`POST`、`PUT`、`DELETE`
   - 或选择"全部"

4. **认证方式**
   - 选择：`无需认证`（No authentication）
   - **注意**：在函数计算中，"无需认证"就是匿名访问的意思
   - 这样前端可以直接访问

5. **路径配置**
   - 路径：`/` 或 `/api/*`
   - 建议使用 `/` 表示所有路径

6. **点击"确定"**
   - 等待触发器创建完成

### 4.3 获取访问地址

1. **查看触发器列表**
   - 创建成功后，会显示触发器信息
   - 找到"公网访问地址"或"HTTP 触发器地址"

2. **复制地址**
   - 地址格式类似：`https://xxx.cn-hangzhou.fcapp.run`
   - **复制这个地址**，后续在 ESA 配置中使用
   - 例如：`https://drug-api-xxx.cn-hangzhou.fcapp.run`

## 🧪 第五步：测试函数

### 5.1 测试健康检查

1. **打开浏览器或使用 curl**
   ```bash
   curl https://your-function-url.cn-hangzhou.fcapp.run/
   ```

2. **预期结果**
   - 应该返回 JSON：
     ```json
     {"message":"药品识别与提醒系统 API","docs":"/docs"}
     ```

### 5.2 测试 API 接口

1. **测试获取药品列表**
   ```bash
   curl https://your-function-url.cn-hangzhou.fcapp.run/api/drugs
   ```

2. **预期结果**
   - 应该返回 JSON 数组（可能是空的 `[]`）

### 5.3 如果测试失败

1. **检查函数日志**
   - 在函数详情页，点击"日志"标签
   - 查看错误信息

2. **常见问题**
   - 环境变量未配置：检查环境变量是否正确
   - 代码错误：检查代码上传是否正确
   - 超时：增加超时时间

## 📝 第六步：在 ESA 配置前端

### 6.1 登录 ESA 控制台

1. **访问 ESA 控制台**
   - https://esa.console.aliyun.com/
   - 找到应用：`drug_serve`

### 6.2 配置环境变量

1. **进入构建信息**
   - 点击"构建信息"或"修改"按钮

2. **找到环境变量部分**
   - 向下滚动到"环境变量"部分

3. **添加环境变量**
   - 点击"添加"按钮
   - 变量名：`VITE_API_BASE_URL`
   - 变量值：`https://your-function-url.cn-hangzhou.fcapp.run`
     - 使用第四步获取的 HTTP 触发器地址
   - 点击"确定"

4. **保存配置**
   - 点击"保存"按钮

### 6.3 重新构建前端

1. **触发构建**
   - 在 ESA 控制台，点击"构建"或"重新部署"
   - 等待构建完成

2. **验证部署**
   - 构建成功后，访问前端应用
   - 检查是否还有连接错误

## ✅ 第七步：验证完整流程

### 7.1 测试前端

1. **打开前端应用**
   - 访问 ESA 提供的前端地址

2. **测试上传功能**
   - 尝试上传一张药品图片
   - 检查是否能正常识别

3. **检查浏览器控制台**
   - 按 F12 打开开发者工具
   - 查看 Network 标签，检查 API 请求
   - 查看 Console 标签，检查错误信息

### 7.2 如果还有问题

1. **检查后端日志**
   - 在函数计算控制台，查看函数日志
   - 检查是否有错误信息

2. **检查环境变量**
   - 确认 ESA 的 `VITE_API_BASE_URL` 配置正确
   - 确认函数计算的环境变量配置正确

## 📊 配置总结

### 函数计算环境变量

```
API_BASE_URL = https://api.chatfire.site/v1/chat/completions
API_KEY = sk-pzZXi9zXV9ERBJFrjAVV4WEMj6u7TcTLtoNUkRfefSrLxlid
MODEL_ID = doubao-1.5-vision-pro-250328
DATABASE_URL = sqlite:///./drugs.db
UPLOAD_DIR = /tmp/uploads
MAX_FILE_SIZE = 10485760
```

### ESA 环境变量

```
VITE_API_BASE_URL = https://your-function-url.cn-hangzhou.fcapp.run
```

## ⚠️ 注意事项

1. **文件存储问题**
   - 函数计算是临时环境，`/tmp` 目录在函数执行结束后会被清空
   - 如果需要持久化存储，需要使用 OSS（对象存储）
   - 当前配置使用 `/tmp/uploads`，适合测试，生产环境建议使用 OSS

2. **数据库问题**
   - SQLite 文件也会在函数实例重启后丢失
   - 如果需要持久化数据，建议使用 RDS（关系型数据库）或表格存储

3. **超时时间**
   - AI 识别可能需要较长时间
   - 如果经常超时，可以增加超时时间到 120 秒

4. **内存规格**
   - 处理图片需要较多内存
   - 如果内存不足，可以增加到 1024 MB 或更高

## 🎉 完成！

按照以上步骤操作，你的后端应该已经成功部署到函数计算了！

如果遇到任何问题，请查看：
- `FC_函数计算部署指南.md` - 更详细的说明
- `ESA_连接问题排查.md` - 连接问题排查

---

**祝你部署顺利！** 🚀

