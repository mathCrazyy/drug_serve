# ESA 前端连接后端问题排查

## 🔴 当前问题

前端显示："无法连接到服务器，请检查网络连接或确认后端服务是否运行"

## 🔍 排查步骤

### 步骤 1: 确认后端是否正常运行

在浏览器中直接访问后端地址：
```
http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run/
```

**应该返回**：
```json
{"message":"药品识别与提醒系统 API","docs":"/docs"}
```

**如果无法访问**：
- 后端可能未部署或已停止
- 需要检查函数计算中的函数状态

### 步骤 2: 检查 ESA 环境变量配置

1. **进入 ESA 控制台**
   - 找到你的应用
   - 点击"构建信息"或"修改"

2. **检查环境变量**
   - 找到"环境变量"部分
   - 确认是否有 `VITE_API_BASE_URL` 环境变量
   - 确认变量值是否正确：
     ```
     VITE_API_BASE_URL=http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run
     ```

3. **如果没有配置或配置错误**
   - 添加或修改环境变量
   - 变量名：`VITE_API_BASE_URL`
   - 变量值：`http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run`
   - **重要**：不要加末尾的斜杠 `/`

### 步骤 3: 重新构建前端

**环境变量修改后，必须重新构建前端！**

1. **触发构建**
   - 在 ESA 控制台，点击"构建"或"重新构建"
   - 等待构建完成

2. **检查构建日志**
   - 查看构建日志中是否有错误
   - 确认构建成功

3. **创建新版本**
   - 构建成功后，创建新的代码版本
   - 等待版本创建完成

4. **发布新版本**
   - 将新版本发布到生产环境
   - 等待部署完成

### 步骤 4: 检查浏览器控制台

1. **打开浏览器开发者工具**
   - 按 F12 或右键 → 检查
   - 切换到"控制台"（Console）标签

2. **查看错误信息**
   - 查看是否有网络错误
   - 查看是否有 CORS 错误
   - 查看具体的错误信息

3. **查看网络请求**
   - 切换到"网络"（Network）标签
   - 刷新页面
   - 查看 API 请求是否发送
   - 查看请求的 URL 是否正确
   - 查看请求的状态码

### 步骤 5: 验证环境变量是否生效

在浏览器控制台中运行：
```javascript
console.log('API Base URL:', import.meta.env.VITE_API_BASE_URL);
```

**应该显示**：
```
API Base URL: http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run
```

**如果显示 `undefined` 或其他值**：
- 环境变量未正确配置
- 需要重新构建前端

## 🔧 常见问题及解决方法

### 问题 1: 环境变量未配置

**症状**：
- 前端显示"无法连接到服务器"
- 浏览器控制台显示请求发送到 `http://localhost:8000`

**解决方法**：
1. 在 ESA 中添加 `VITE_API_BASE_URL` 环境变量
2. 重新构建前端
3. 部署新版本

### 问题 2: 环境变量配置错误

**症状**：
- 环境变量已配置，但前端仍无法连接
- 浏览器控制台显示错误的 API 地址

**解决方法**：
1. 检查环境变量名称是否正确：`VITE_API_BASE_URL`（注意大小写）
2. 检查变量值是否正确：`http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run`
3. 确认没有多余的斜杠或空格
4. 重新构建前端

### 问题 3: 构建时环境变量未生效

**症状**：
- 环境变量已配置
- 但构建后的代码中仍使用默认值

**解决方法**：
1. 确认环境变量名称以 `VITE_` 开头
2. 删除旧的构建缓存
3. 重新构建前端
4. 检查构建日志确认环境变量已注入

### 问题 4: CORS 跨域错误

**症状**：
- 浏览器控制台显示 CORS 错误
- 请求被阻止

**解决方法**：
- 检查后端 CORS 配置（应该已经配置为允许所有来源）
- 如果仍有问题，检查后端日志

### 问题 5: 后端地址无法访问

**症状**：
- 直接在浏览器中访问后端地址失败
- 返回 404 或连接超时

**解决方法**：
1. 检查函数计算中的函数状态
2. 确认 HTTP 触发器已创建
3. 确认触发器认证方式为"无需认证"
4. 检查函数是否正常运行

## 📋 完整检查清单

- [ ] 后端地址可以正常访问
- [ ] ESA 中已配置 `VITE_API_BASE_URL` 环境变量
- [ ] 环境变量值正确（无多余斜杠或空格）
- [ ] 已重新构建前端
- [ ] 已创建新版本
- [ ] 已发布新版本
- [ ] 浏览器控制台无错误
- [ ] 网络请求发送到正确的后端地址

## 🧪 测试步骤

1. **测试后端**
   ```bash
   curl http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run/
   ```
   应该返回：`{"message":"药品识别与提醒系统 API","docs":"/docs"}`

2. **测试前端**
   - 打开前端页面
   - 打开浏览器开发者工具（F12）
   - 查看 Network 标签
   - 刷新页面
   - 查看是否有请求发送到后端

3. **测试 API 端点**
   - 在浏览器中访问：`http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run/api/drugs`
   - 应该返回：`[]`（空数组，表示没有药品）

## 🎯 快速修复步骤

如果前端仍显示"无法连接到服务器"，按以下步骤操作：

1. **确认后端正常**
   - 访问：http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run/
   - 确认可以正常访问

2. **配置 ESA 环境变量**
   - 变量名：`VITE_API_BASE_URL`
   - 变量值：`http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run`

3. **重新构建**
   - 在 ESA 控制台触发构建
   - 等待构建完成

4. **部署新版本**
   - 创建新版本
   - 发布到生产环境

5. **清除浏览器缓存**
   - 按 Ctrl+Shift+R（Windows）或 Cmd+Shift+R（Mac）强制刷新
   - 或清除浏览器缓存后重新访问

---

**按照以上步骤排查，应该能解决连接问题！** 🚀
