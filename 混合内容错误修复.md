# 混合内容错误修复指南

## 🔴 当前问题

Chrome DevTools 显示：`(已屏蔽: mixed-content)` (Blocked: mixed-content)

**问题原因**：
- 前端部署在 ESA 上，使用 **HTTPS** 协议
- 后端地址配置为 `http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run`（**HTTP** 协议）
- 浏览器安全策略阻止从 HTTPS 页面向 HTTP 后端发送请求（混合内容）

## ✅ 解决方案

### 已验证：HTTPS 可用 ✅

测试结果：
```bash
curl https://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run/
# 返回：{"message":"药品识别与提醒系统 API","docs":"/docs"}
```

**函数计算的 HTTPS 完全可用！**

### 修复步骤

#### 步骤 1: 在 ESA 中更新环境变量

1. **进入 ESA 控制台**
   - 找到你的应用
   - 点击"构建信息"或"修改"

2. **找到环境变量**
   - 找到 `VITE_API_BASE_URL` 环境变量
   - 点击"编辑"或"修改"

3. **修改变量值**
   ```
   从：http://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run
   改为：https://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run
   ```
   
   **关键改动**：将 `http://` 改为 `https://`

4. **保存环境变量**
   - 点击"保存"或"确定"

#### 步骤 2: 重新构建前端

**重要：环境变量修改后，必须重新构建！**

1. **触发构建**
   - 在构建信息页面，点击"构建"或"重新构建"
   - 等待构建完成（可能需要几分钟）

2. **检查构建日志**
   - 确认构建成功
   - 查看是否有错误

#### 步骤 3: 部署新版本

1. **创建新版本**
   - 构建成功后，创建新的代码版本
   - 等待版本创建完成

2. **发布新版本**
   - 将新版本发布到生产环境
   - 等待部署完成

#### 步骤 4: 清除缓存并测试

1. **清除浏览器缓存**
   - 按 `Ctrl+Shift+R`（Windows）或 `Cmd+Shift+R`（Mac）强制刷新
   - 或清除浏览器缓存后重新访问

2. **测试连接**
   - 打开前端页面
   - 尝试上传图片
   - 查看是否还有"无法连接到服务器"的错误
   - 在 Chrome DevTools 的 Network 标签中，应该不再看到 `mixed-content` 错误

## 🔍 验证修复

### 方法 1: 检查浏览器控制台

1. **打开浏览器开发者工具**（F12）
2. **切换到控制台标签**
3. **运行验证命令**：
   ```javascript
   console.log('API Base URL:', import.meta.env.VITE_API_BASE_URL);
   ```
4. **应该显示**：
   ```
   API Base URL: https://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run
   ```
   （注意是 `https://`，不是 `http://`）

### 方法 2: 检查网络请求

1. **打开浏览器开发者工具**（F12）
2. **切换到网络标签**
3. **刷新页面并上传图片**
4. **查看网络请求**：
   - 请求的 URL 应该是 `https://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run`
   - 状态应该是 `200` 或 `201`（成功）
   - **不应该**再看到 `mixed-content` 错误

## 📋 完整操作清单

- [ ] 进入 ESA 控制台 → 构建信息 → 环境变量
- [ ] 找到 `VITE_API_BASE_URL` 环境变量
- [ ] 修改变量值：`https://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run`
- [ ] 保存环境变量
- [ ] 触发重新构建
- [ ] 等待构建完成
- [ ] 创建新版本
- [ ] 部署新版本
- [ ] 清除浏览器缓存
- [ ] 测试上传功能
- [ ] 验证 Network 标签中不再有 `mixed-content` 错误

## ⚠️ 重要提示

1. **混合内容错误是浏览器安全策略**
   - 现代浏览器默认阻止 HTTPS 页面加载 HTTP 资源
   - 这是为了安全考虑，无法绕过

2. **函数计算支持 HTTPS**
   - 函数计算的 HTTP 触发器同时支持 HTTP 和 HTTPS
   - 只需要将 URL 从 `http://` 改为 `https://`

3. **修改后必须重新构建**
   - 环境变量修改后，必须重新构建前端
   - 必须部署新版本
   - 必须清除浏览器缓存

## 🎯 快速修复步骤

```
1. ESA 控制台 → 构建信息 → 环境变量
   ↓
2. 找到 VITE_API_BASE_URL → 编辑
   ↓
3. 修改为：https://drug-api-yjdprwpdbq.cn-hangzhou.fcapp.run
   ↓
4. 保存 → 重新构建 → 部署新版本
   ↓
5. 清除缓存 → 测试
```

## 💡 为什么会出现这个问题？

1. **前端使用 HTTPS**：ESA 部署的前端默认使用 HTTPS
2. **后端使用 HTTP**：环境变量中配置的是 `http://`
3. **浏览器阻止**：浏览器安全策略不允许 HTTPS 页面请求 HTTP 资源
4. **解决方案**：将后端地址改为 HTTPS

---

**将后端地址改为 HTTPS 即可解决混合内容错误！** 🚀
