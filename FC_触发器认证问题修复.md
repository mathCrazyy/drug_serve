# 函数计算 HTTP 触发器认证问题修复

## 🔴 当前错误

```json
{
  "RequestId": "1-694767a9-1544714a-ca2bdbd760f4",
  "Code": "MissingRequiredHeader",
  "Message": "required HTTP header Date was not specified"
}
```

## 🔍 问题原因

HTTP 触发器配置了**签名认证**，而不是**匿名访问**。

- **签名认证**：需要特殊的 HTTP 头（如 Date），用于安全访问
- **匿名访问**：可以直接通过浏览器或 curl 访问，适合前端调用

## ✅ 解决方法

### 步骤 1: 修改触发器认证方式

1. **进入函数计算控制台**
   - 找到你的函数：`drug-se-backend`
   - 点击进入函数详情页

2. **进入触发器页面**
   - 点击"触发器"标签
   - 找到 HTTP 触发器（应该是 `defaultTrigger`）

3. **编辑触发器**
   - 点击触发器右侧的"编辑"或"修改"按钮
   - 或点击触发器名称进入编辑页面

4. **修改认证方式**
   - 找到"认证方式"或"认证配置"
   - 将"签名认证"改为"**匿名访问**"
   - 保存修改

### 步骤 2: 重新测试

修改后，再次测试：

```bash
curl https://drug-se-backend-laubwkztsv.cn-hangzhou.fcapp.run/
```

应该返回：
```json
{"message":"药品识别与提醒系统 API","docs":"/docs"}
```

## 📝 详细操作步骤

### 方法 A: 在触发器列表编辑

1. **进入触发器页面**
   - 函数详情页 → "触发器"标签

2. **找到 HTTP 触发器**
   - 列表中应该有一个 HTTP 触发器
   - 名称可能是 `defaultTrigger` 或其他名称

3. **点击编辑**
   - 点击触发器右侧的"编辑"图标（齿轮图标）
   - 或点击触发器名称

4. **修改认证方式**
   - 在编辑页面，找到"认证方式"
   - 下拉选择"**匿名访问**"
   - 点击"确定"或"保存"

### 方法 B: 删除并重新创建触发器

如果无法编辑，可以删除后重新创建：

1. **删除现有触发器**
   - 在触发器列表，点击"删除"
   - 确认删除

2. **创建新触发器**
   - 点击"创建触发器"
   - 触发器类型：HTTP 触发器
   - 认证方式：**匿名访问**（重要！）
   - 请求方法：全选（GET, POST, PUT, DELETE）
   - 点击"确定"

## 🧪 验证修复

修改后，测试以下命令：

### 1. 测试健康检查

```bash
curl https://drug-se-backend-laubwkztsv.cn-hangzhou.fcapp.run/
```

**预期结果**：
```json
{"message":"药品识别与提醒系统 API","docs":"/docs"}
```

### 2. 测试 API 接口

```bash
curl https://drug-se-backend-laubwkztsv.cn-hangzhou.fcapp.run/api/drugs
```

**预期结果**：
```json
[]
```
（空数组，表示没有药品数据，这是正常的）

### 3. 测试前端连接

1. **在 ESA 配置环境变量**
   - 变量名：`VITE_API_BASE_URL`
   - 变量值：`https://drug-se-backend-laubwkztsv.cn-hangzhou.fcapp.run`

2. **重新构建前端**
   - 在 ESA 控制台触发新的构建

3. **测试前端**
   - 打开前端应用
   - 检查是否还有连接错误

## ⚠️ 注意事项

1. **匿名访问的安全性**
   - 匿名访问意味着任何人都可以调用你的 API
   - 对于这个项目，这是可以接受的（因为前端需要访问）
   - 如果担心安全，可以在后端代码中添加 API Key 验证

2. **签名认证的用途**
   - 签名认证用于服务间调用
   - 需要特殊的 SDK 或签名算法
   - 不适合前端直接调用

## 📊 触发器配置对比

| 配置项 | 签名认证 | 匿名访问 |
|--------|---------|---------|
| 访问方式 | 需要签名 | 直接访问 |
| 适用场景 | 服务间调用 | 前端调用 |
| 安全性 | 高 | 中 |
| 配置复杂度 | 复杂 | 简单 |
| **本项目** | ❌ | ✅ |

## 🎯 完整配置检查清单

修改触发器后，确认：

- [ ] 触发器认证方式已改为"匿名访问"
- [ ] curl 测试返回正确的 JSON 数据
- [ ] ESA 环境变量 `VITE_API_BASE_URL` 已配置
- [ ] 前端已重新构建
- [ ] 前端可以正常连接后端

---

**按照以上步骤修改触发器认证方式，问题应该就能解决了！** 🚀

