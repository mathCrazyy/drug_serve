# 函数计算 412 Precondition Failed 错误修复

## 🔴 当前错误

**状态码**：`412 Precondition Failed`  
**错误类型**：`X-Fc-Error-Type: FCCommonError`  
**请求**：`POST /api/drugs/upload`

## 🔍 问题原因

412 错误在函数计算中通常表示：

1. **请求体大小超过限制**
   - 函数计算对请求体大小有限制
   - 默认限制通常是 **6MB** 或更小
   - 上传的图片文件可能超过了这个限制

2. **函数计算配置限制**
   - 函数计算的 HTTP 触发器可能有请求体大小限制
   - 需要在函数配置中调整

## ✅ 解决方案

### 方案 1: 增加函数计算的请求体大小限制（推荐）

#### 步骤 1: 检查函数配置

1. **进入函数计算控制台**
   - 找到你的函数
   - 点击进入函数详情页

2. **进入函数配置**
   - 点击"配置"标签
   - 找到"高级配置"或"请求配置"

3. **查找请求体大小限制**
   - 查找"请求体大小限制"或"Body Size Limit"
   - 查看当前限制值

#### 步骤 2: 增加限制

1. **修改请求体大小限制**
   - 将限制增加到 **10MB** 或更大
   - 建议设置为 **20MB**（足够上传多张图片）

2. **保存配置**
   - 点击"保存"按钮
   - 等待配置生效

### 方案 2: 优化前端上传（如果无法修改限制）

如果无法修改函数计算的请求体大小限制，可以优化前端上传：

#### 方法 A: 压缩图片

在前端上传前压缩图片：

```typescript
// 在 ImageUpload.tsx 中添加图片压缩
const compressImage = (file: File, maxWidth: number = 1920, quality: number = 0.8): Promise<File> => {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx?.drawImage(img, 0, 0, width, height);
        
        canvas.toBlob(
          (blob) => {
            if (blob) {
              const compressedFile = new File([blob], file.name, {
                type: file.type,
                lastModified: Date.now(),
              });
              resolve(compressedFile);
            } else {
              resolve(file);
            }
          },
          file.type,
          quality
        );
      };
      img.src = e.target?.result as string;
    };
    reader.readAsDataURL(file);
  });
};
```

#### 方法 B: 限制上传文件大小

在前端添加文件大小检查：

```typescript
const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  if (e.target.files) {
    const files = Array.from(e.target.files);
    const validFiles = files.filter(file => {
      if (file.size > MAX_FILE_SIZE) {
        alert(`文件 ${file.name} 超过 5MB 限制，请选择较小的图片`);
        return false;
      }
      return true;
    });
    // ... 处理 validFiles
  }
};
```

### 方案 3: 使用 OSS 上传（最佳方案）

如果图片较大，建议使用阿里云 OSS 存储：

1. **前端直接上传到 OSS**
   - 使用 OSS 的预签名 URL
   - 前端直接上传到 OSS
   - 上传成功后，将 OSS URL 发送给后端

2. **后端从 OSS 读取**
   - 后端从 OSS 读取图片
   - 进行分析处理

这样可以避免请求体大小限制问题。

## 📋 快速修复步骤

### 如果可以选择方案 1（推荐）

1. **进入函数计算控制台**
   - 函数详情 → 配置 → 高级配置

2. **找到请求体大小限制**
   - 查找"请求体大小限制"或"Body Size Limit"

3. **增加限制**
   - 设置为 **20MB** 或更大
   - 保存配置

4. **测试上传**
   - 重新尝试上传图片
   - 应该不再出现 412 错误

### 如果无法修改限制

1. **在前端添加文件大小检查**
   - 限制上传文件大小在 5MB 以内
   - 或添加图片压缩功能

2. **优化用户体验**
   - 显示文件大小提示
   - 自动压缩大图片

## 🔍 验证修复

### 方法 1: 检查函数配置

在函数计算控制台：
- 配置 → 高级配置 → 请求体大小限制
- 确认限制值足够大（建议 20MB）

### 方法 2: 测试上传

1. **上传小图片**（< 1MB）
   - 应该成功

2. **上传大图片**（> 6MB）
   - 如果仍然失败，说明限制未生效
   - 需要检查配置或使用其他方案

## ⚠️ 重要提示

1. **函数计算的默认限制**
   - 不同地区的函数计算可能有不同的默认限制
   - 通常是 6MB 或 10MB

2. **请求体大小 vs 文件大小**
   - 请求体大小包括 HTTP 头、multipart 边界等
   - 实际可上传的文件大小会略小于限制值

3. **多文件上传**
   - 如果上传多张图片，总大小不能超过限制
   - 建议单张图片限制在 5MB 以内

## 🎯 推荐配置

```
请求体大小限制：20MB
单文件大小限制：5MB（在前端检查）
多文件上传：最多 3-4 张图片
```

---

**按照以上步骤修复，412 错误应该可以解决！** 🚀

